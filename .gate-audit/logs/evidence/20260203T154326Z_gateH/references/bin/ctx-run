#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
MANIFEST="$ROOT/rules/ssot_manifest.yaml"
LOG_DIR="$ROOT/LOGS/ctx-run"

print_flag=0
out_path=""

usage() {
  cat <<'USAGE'
Usage: ctx-run [--print] [--out <path>] [-h|--help]

Options:
  --print        Print bundle to stdout
  --out <path>   Write bundle to file
  -h, --help     Show help
USAGE
}

while [ $# -gt 0 ]; do
  case "$1" in
    --print)
      print_flag=1
      shift
      ;;
    --out)
      if [ $# -lt 2 ]; then
        echo "ERROR: --out requires a path" >&2
        exit 2
      fi
      out_path="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "ERROR: unknown arg: $1" >&2
      usage
      exit 2
      ;;
  esac
done

if [ "$print_flag" -eq 0 ] && [ -z "$out_path" ]; then
  echo "ERROR: specify --print and/or --out" >&2
  usage
  exit 2
fi

if [ ! -f "$MANIFEST" ]; then
  echo "ERROR: manifest not found: $MANIFEST" >&2
  exit 1
fi

mapfile -t ssot_files < <(
  awk '
    $0 ~ /^ssot:/ {in_ssot=1; next}
    in_ssot && $0 ~ /^[^[:space:]]/ {in_ssot=0}
    in_ssot && $0 ~ /^[[:space:]]*-/ {
      sub(/^[[:space:]]*-[[:space:]]*/, "", $0); print $0
    }
  ' "$MANIFEST"
)

if [ "${#ssot_files[@]}" -eq 0 ]; then
  echo "ERROR: no ssot entries in manifest" >&2
  exit 1
fi

mkdir -p "$LOG_DIR"
log_file="$LOG_DIR/ctx-run-$(date +%Y%m%d-%H%M%S).log"

tmp_bundle="$(mktemp)"

for rel in "${ssot_files[@]}"; do
  rel="${rel%\"}"
  rel="${rel#\"}"
  rel="${rel%\'}"
  rel="${rel#\'}"
  [ -z "$rel" ] && continue

  abs="$ROOT/$rel"
  if [ ! -f "$abs" ]; then
    echo "ERROR: missing ssot file: $rel" >&2
    rm -f "$tmp_bundle"
    exit 1
  fi

  printf "===== BEGIN %s =====\n" "$rel" >> "$tmp_bundle"
  cat "$abs" >> "$tmp_bundle"
  printf "\n===== END %s =====\n" "$rel" >> "$tmp_bundle"

done

{
  echo "timestamp: $(date -Iseconds)"
  echo "manifest: $MANIFEST"
  echo "ssot_files:"
  for rel in "${ssot_files[@]}"; do
    rel="${rel%\"}"
    rel="${rel#\"}"
    rel="${rel%\'}"
    rel="${rel#\'}"
    [ -z "$rel" ] && continue
    echo "  - $rel"
  done
  echo "print: $print_flag"
  echo "out: ${out_path:-"-"}"
} > "$log_file"

if [ -n "$out_path" ]; then
  cp "$tmp_bundle" "$out_path"
fi

if [ "$print_flag" -eq 1 ]; then
  cat "$tmp_bundle"
fi

rm -f "$tmp_bundle"
